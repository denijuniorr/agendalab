<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <title>Agendamento Global</title>

  <style>
    body{font-family:Arial;margin:0;padding:0;background:#f2f2f2;}
    .wrap{display:flex;max-width:800px;margin:40px auto;gap:20px;}
    .form, .lista{background:#fff;padding:20px;border-radius:6px;flex:1;}
    input, button{width:100%;padding:10px;margin:6px 0;box-sizing:border-box;}
    .item{border:1px solid #ddd;padding:8px;margin:4px 0;display:flex;justify-content:space-between;align-items:center;}
    .cancel{background:#e74c3c;color:#fff;border:none;padding:4px 8px;cursor:pointer;}
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="form">
      <h2>Agendar equipamento</h2>

      <input id="nome" placeholder="Seu nome">
      <input id="equip" placeholder="Nome do equipamento">

      <label>Data e hora do fim:</label>
      <input id="dataFim" type="datetime-local">

      <button onclick="salvar()">Criar agendamento</button>
    </div>

    <div class="lista">
      <h2>Agendamentos</h2>
      <div id="listagem">Carregandoâ€¦</div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCd5eVLTG5_3_2lI61AB-gcbuz4wjmZCZY",
      authDomain: "teste192-9b4e9.firebaseapp.com",
      databaseURL: "https://teste192-9b4e9-default-rtdb.firebaseio.com",
      projectId: "teste192-9b4e9",
      storageBucket: "teste192-9b4e9.firebasestorage.app",
      messagingSenderId: "1063522852340",
      appId: "1:1063522852340:web:d0144ce6c187f289f6eda1",
      measurementId: "G-2K0W4KF291"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const agendRef = db.ref('agendamentos');

    // ðŸ”¥ CONVERSÃƒO CORRETA DE datetime-local (sem erro de fuso)
    function converterDataLocal(str) {
      const [data, hora] = str.split("T");
      const [ano, mes, dia] = data.split("-").map(Number);
      const [h, m] = hora.split(":").map(Number);

      // Cria data NO FUSO LOCAL sem converter para UTC
      return new Date(ano, mes - 1, dia, h, m).getTime();
    }

    // Criar agendamento
    function salvar(){
      const n = document.getElementById('nome').value.trim();
      const e = document.getElementById('equip').value.trim();
      const d = document.getElementById('dataFim').value;

      if(!n || !e || !d){
        alert('Preencha tudo');
        return;
      }

      const timestampFim = converterDataLocal(d);

      // bloquear datas passadas
      if(timestampFim < Date.now()){
        alert("A data final nÃ£o pode ser no passado.");
        return;
      }

      agendRef.push({
        nome: n,
        equip: e,
        dataFim: timestampFim
      });

      document.getElementById('nome').value = '';
      document.getElementById('equip').value = '';
      document.getElementById('dataFim').value = '';
    }

    function cancelar(id){
      const senha = prompt('Digite a senha:');
      if(senha !== 'engenhariaexata') return;
      agendRef.child(id).remove();
    }

    // Auto remover vencidos
    function verificarExpirados(dados){
      const agora = Date.now();

      Object.keys(dados).forEach(id => {
        if (dados[id].dataFim < agora){
          agendRef.child(id).remove();
        }
      });
    }

    // Exibir
    agendRef.on('value', snap => {
      const dados = snap.val() || {};

      verificarExpirados(dados);

      const html = Object.keys(dados).map(id => {
        const a = dados[id];
        const data = new Date(a.dataFim).toLocaleString("pt-BR");

        return `
          <div class="item">
            <span>${a.nome} - ${a.equip} | AtÃ© ${data}</span>
            <button class="cancel" onclick="cancelar('${id}')">Cancelar</button>
          </div>
        `;
      }).join('');

      document.getElementById('listagem').innerHTML = html || 'Nenhum agendamento.';
    });
  </script>
</body>
</html>
